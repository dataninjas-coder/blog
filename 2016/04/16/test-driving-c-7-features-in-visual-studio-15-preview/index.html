<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Test driving C# 7 features in Visual Studio “15” Preview - Thomas Levesque&#39;s .NET Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-31621259-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Thomas Levesque&#39;s .NET Blog" rel="home">
				<div class="logo__title">Thomas Levesque&#39;s .NET Blog</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Test driving C# 7 features in Visual Studio “15” Preview</h1>
			
		</header><div class="content post__content clearfix">
			<p>About two weeks ago, Microsoft released the first preview of the next version of Visual Studio. You can read about what’s new in the <a href="https://www.visualstudio.com/en-us/news/vs15-preview-vs.aspx#CsharpAndVB">release notes</a>. Some of the new features are really nice (for instance I love the new “lightweight installer”), but the most interesting for me is that it comes with a version of the compiler that includes a few of the features planned for C# 7. Let’s have a closer look at them!</p>
<h3 id="enabling-the-new-features">Enabling the new features</h3>
<p>The new features are not enabled by default. You can enable them individually with <code>/feature:</code> command line switches, but the easiest way is to enable them all by adding <code>__DEMO__</code> and <code>__DEMO_EXPERIMENTAL__</code> to the conditional compilation symbols (in <em>Project properties</em>, <em>Build</em> tab).</p>
<h3 id="local-functions">Local functions</h3>
<p>Most functional languages allow you to declare functions in the body of other functions. It’s now possible to do the same in C# 7! The syntax for declaring a method inside another is pretty much what you would expect:</p>
<pre><code>long Factorial(int n)
{
    long Fact(int i, long acc)
    {
        return i == 0 ? acc : Fact(i - 1, acc * i);
    }
    return Fact(n, 1);
}
</code></pre><p>Here, the <code>Fact</code> method is local to the <code>Factorial</code> method (in case you’re wondering, it’s a tail-recursive implementation of the factorial — which doesn’t make much sense, since C# doesn’t support tail recursion, but it’s just an example).</p>
<p>Of course, it was already possible to simulate local functions with lambda expressions, but there were a few drawbacks:</p>
<ul>
<li>it’s less readable, because you have to declare the delegate type explicitly</li>
<li>it’s slower, due to the overhead of creating a delegate instance, and calling the delegate vs. calling the method directly</li>
<li>writing recursive lambdas is a bit awkward</li>
</ul>
<p>Local functions have the following benefits:</p>
<ul>
<li>when a method is only used as a helper for another method, making it local makes the relation more obvious</li>
<li>like lambdas, local functions can capture local variables and parameters of their containing method</li>
<li>local functions support recursion like any normal method</li>
</ul>
<p>You can read more about this feature <a href="https://github.com/dotnet/roslyn/issues/2930">in the Roslyn Github repository</a>.</p>
<h3 id="ref-returns-and-ref-locals">Ref returns and ref locals</h3>
<p>Since the first version of C#, it has always been possible to pass parameters by reference, which is conceptually similar to passing a pointer to a variable in languages like C. Until now, this feature was limited to parameters, but in C# 7 it becomes possible to return values by reference, or to have local variables that refer to the location of another variable. Here’s an example:</p>
<pre><code>static void TestRefReturn()
{
    var foo = new Foo();
    Console.WriteLine(foo); // 0, 0
    
    foo.GetByRef(&quot;x&quot;) = 42;

    ref int y = ref foo.GetByRef(&quot;y&quot;);
    y = 99;

    Console.WriteLine(foo); // 42, 99
}

class Foo
{
    private int x;
    private int y;

    public ref int GetByRef(string name)
    {
        if (name == &quot;x&quot;)
            return ref x;
        if (name == &quot;y&quot;)
            return ref y;
        throw new ArgumentException(nameof(name));
    }

    public override string ToString() =&gt; $&quot;{x},{y}&quot;;
}
</code></pre><p>Let’s have a closer look at this code.</p>
<ul>
<li>On line 6, it looks like I’m assigning a value to the return of a method; what does this even mean? Well, the <code>GetByRef</code> method returns a field of the <code>Foo</code> class <em>by reference</em> (note the <code>ref int</code> return type of <code>GetByRef</code>). So, if I pass <code>&quot;x&quot;</code> as an argument, it returns the <code>x</code> field by reference. If I assign a value to that, it actually assigns a value to the <code>x</code> field.</li>
<li>On line 8, instead of just assigning a value directly to the field returned by <code>GetByRef</code>, I use a ref local variable <code>y</code>. The local variable now shares the same memory location as the <code>foo.y</code> field. So if I assign a value to it, it changes the value of <code>foo.y</code>.</li>
</ul>
<p>Note that you can also return an array location by reference:</p>
<pre><code>private MyBigStruct[] array = new MyBigStruct[10];
private int current;

public ref MyBigStruct GetCurrentItem()
{
    return ref array[current];
}
</code></pre><p>It’s likely that most C# developers will never actually need this feature; it’s pretty low level, and not the kind of thing you typically need when writing line-of-business applications. However it’s very useful for code whose performance is critical: copying a large structure is expensive, so if we can return it by reference instead, it can be a non-negligible performance benefit.</p>
<p>You can learn more about this feature <a href="https://github.com/dotnet/roslyn/issues/118">on Github</a>.</p>
<h3 id="pattern-matching">Pattern matching</h3>
<p>Pattern matching is a feature very common in functional languages. C# 7 introduces some aspects of pattern matching, in the form of extensions to the <code>is</code> operator. For instance, when testing the type of a variable, it lets you introduce a new variable after the type, so that this variable is assigned with the left-hand side operand of the <code>is</code>, but with the type specified as the right-hand side operand (it will be clearer with an example).</p>
<p>Typically, if you need to test that a value is of type <code>DateTime</code>, then do something with that <code>DateTime</code>, you need to test the type, then cast to that type:</p>
<pre><code>object o = GetValue();
if (o is DateTime)
{
    var d = (DateTime)o;
    // Do something with d
}
</code></pre><p>In C# 7, you can do this instead:</p>
<pre><code>object o = GetValue();
if (o is DateTime d)
{
    // Do something with d
}
</code></pre><p><code>d</code> is now declared directly as part of the <code>o is DateTime</code> expression.</p>
<p>This feature can also be used in a switch statement:</p>
<pre><code>object v = GetValue();
switch (v)
{
    case string s:
        Console.WriteLine($&quot;{v} is a string of length {s.Length}&quot;);
        break;
    case int i:
        Console.WriteLine($&quot;{v} is an {(i % 2 == 0 ? &quot;even&quot; : &quot;odd&quot;)} int&quot;);
        break;
    default:
        Console.WriteLine($&quot;{v} is something else&quot;);
        break;
}
</code></pre><p>In this code, each case introduces a variable of the appropriate type, which you can use in the body of the case.</p>
<p>So far I only covered pattern matching against a simple type, but there are also more advanced forms. For instance:</p>
<pre><code>switch (DateTime.Today)
{
    case DateTime(*, 10, 31):
        Console.WriteLine(&quot;Happy Halloween!&quot;);
        break;
    case DateTime(var year, 7, 4) when year &gt; 1776:
        Console.WriteLine(&quot;Happy Independence Day!&quot;);
        break;
    case DateTime { DayOfWeek is DayOfWeek.Saturday }:
    case DateTime { DayOfWeek is DayOfWeek.Sunday }:
        Console.WriteLine(&quot;Have a nice week-end!&quot;);
        break;
    default:
        break;
}
</code></pre><p>How cool is that!</p>
<p>There’s also another (still experimental) form of pattern matching, using a new <code>match</code> keyword:</p>
<pre><code>object o = GetValue();
string description = o match
    (
        case string s : $&quot;{o} is a string of length {s.Length}&quot;
        case int i : $&quot;{o} is an {(i % 2 == 0 ? &quot;even&quot; : &quot;odd&quot;)} int&quot;
        case * : $&quot;{o} is something else&quot;
    );
</code></pre><p>It’s very similar to a switch, except that it’s an expression, not a statement.</p>
<p>There’s a lot more to pattern matching than what I mentioned here. You can look at <a href="https://github.com/dotnet/roslyn/blob/features/patterns/docs/features/patterns.md">the spec</a> on Github for more details.</p>
<h3 id="binary-literals-and-digit-separators">Binary literals and digit separators</h3>
<p>These features were not explicitly mentioned in the VS Preview release notes, but I noticed they were included as well. They were initially planned for C# 6, but didn’t make it in the final release. They’re back in C# 7.</p>
<p>You can now write numeric literal in binary, in addition to decimal an hexadecimal:</p>
<pre><code>int x = 0b11001010;
</code></pre><p>Very convenient to define bit masks!</p>
<p>To make large numbers more readable, you can also group digits by introducing separators. This can be used for decimal, hexadecimal or binary literals:</p>
<pre><code>int oneBillion = 1_000_000_000;
int foo = 0x7FFF_1234;
int bar = 0b1001_0110_1010_0101;
</code></pre><h3 id="conclusion">Conclusion</h3>
<p>So, with Visual Studio “15” Preview, you can start experimenting with the new C# 7 features; don’t hesitate to share your feedback on Github! And keep in mind that it’s still pre-release software, lots of things can change before the final release.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/c/" rel="tag">C#</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/c#-7/" rel="tag">C# 7</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/visual-studio/" rel="tag">Visual Studio</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>





			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 Thomas Levesque&#39;s .NET Blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>