<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Pitfall: using var and async together - Thomas Levesque&#39;s .NET Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-31621259-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Thomas Levesque&#39;s .NET Blog" rel="home">
				<div class="logo__title">Thomas Levesque&#39;s .NET Blog</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Pitfall: using var and async together</h1>
			
		</header><div class="content post__content clearfix">
			<p>A few days ago at work, I stumbled upon a sneaky bug in our main app. The code looked innocent enough, and at first glance I couldn’t understand what was wrong… The code was similar to the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">bool</span>&gt; BookExistsAsync(<span style="color:#66d9ef">int</span> id)
{
    <span style="color:#66d9ef">var</span> store = <span style="color:#66d9ef">await</span> GetBookStoreAsync();
    <span style="color:#66d9ef">var</span> book = store.GetBookByIdAsync(id);
    <span style="color:#66d9ef">return</span> book != <span style="color:#66d9ef">null</span>;
}

<span style="color:#75715e">// For completeness, here are the types and methods used in BookExistsAsync:
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">private</span> Task&lt;IBookStore&gt; GetBookStoreAsync()
{
    <span style="color:#75715e">// actual implementation irrelevant
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}


<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> IBookStore
{
    Task&lt;Book&gt; GetBookByIdAsync(<span style="color:#66d9ef">int</span> id);
    <span style="color:#75715e">// other members omitted for brevity
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Book</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Id { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
    <span style="color:#75715e">// other members omitted for brevity
</span><span style="color:#75715e"></span>}
</code></pre></div><p>The <code>BookExistsAsync</code> method always returns true. Can you see why ?</p>
<p>Look at this line:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">var</span> book = store.GetBookByIdAsync(id);
</code></pre></div><p>Quick, what’s the type of <code>book</code>? If you answered <code>Book</code>, think again: it’s <code>Task&lt;Book&gt;</code>. The <code>await</code> is missing! And an <code>async</code> method always returns a non-null task, so <code>book</code>  is never null.</p>
<p>When you have an <code>async</code> method with no <code>await</code>, the compiler warns you, but in this case there is an <code>await</code> on the line above. The only thing we do with <code>book</code> is to check that it’s not <code>null</code>; since <code>Task&lt;T&gt;</code> is a reference type, there’s nothing suspicious in comparing it to <code>null</code>. So, the compiler sees nothing wrong; the static code analyzer (ReSharper in this case) sees nothing wrong; and of course the feeble human brain reviewing the code sees nothing wrong either… Obviously, it could easily have been detected with adequate unit test coverage, but unfortunately this method wasn’t covered.</p>
<p>So, how to avoid this kind of mistake? Stop using <code>var</code> and always specify types explicitly? But I <em>like</em> <code>var</code>, I use it almost everywhere! Besides, I think it’s the first time I ever found a bug caused by the use of <code>var</code>. I’m really not willing to give it up…</p>
<p>Ideally, I would have liked ReSharper to spot the issue; perhaps it should consider all <code>Task</code>-returning methods to be implicitly <code>[NotNull]</code>, unless specified otherwise. Until then, I don’t have a silver bullet against this issue; just pay attention when you call an async method, and write unit tests!</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/async/" rel="tag">async</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/bug/" rel="tag">bug</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/c/" rel="tag">C#</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/resharper/" rel="tag">ReSharper</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/testing/" rel="tag">testing</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/unit/" rel="tag">unit</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>





			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 Thomas Levesque&#39;s .NET Blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>