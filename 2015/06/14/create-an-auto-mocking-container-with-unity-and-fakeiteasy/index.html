<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Create an auto-mocking container with Unity and FakeItEasy | Thomas Levesque .NET Blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.69.2" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.1cb140d8ba31d5b2f1114537dd04802a.css" rel="stylesheet">
    

    

    
      
    

    
    
    <meta property="og:title" content="Create an auto-mocking container with Unity and FakeItEasy" />
<meta property="og:description" content="Unit testing can be tedious sometimes, especially when testing classes that have complex dependencies. Fortunately, some tools make it somewhat easier. I’ve been using FakeItEasy a lot recently; it’s a very easy to use mocking framework for .NET. It has a very lean and simple API based on generics and lambda expressions, and is a real pleasure to work with. It came as a breath of fresh air compared to the old RhinoMocks I had been using before." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog2.thomaslevesque.net/2015/06/14/create-an-auto-mocking-container-with-unity-and-fakeiteasy/" />
<meta property="article:published_time" content="2015-06-14T20:00:47+00:00" />
<meta property="article:modified_time" content="2015-06-14T20:00:47+00:00" />
<meta itemprop="name" content="Create an auto-mocking container with Unity and FakeItEasy">
<meta itemprop="description" content="Unit testing can be tedious sometimes, especially when testing classes that have complex dependencies. Fortunately, some tools make it somewhat easier. I’ve been using FakeItEasy a lot recently; it’s a very easy to use mocking framework for .NET. It has a very lean and simple API based on generics and lambda expressions, and is a real pleasure to work with. It came as a breath of fresh air compared to the old RhinoMocks I had been using before.">
<meta itemprop="datePublished" content="2015-06-14T20:00:47&#43;00:00" />
<meta itemprop="dateModified" content="2015-06-14T20:00:47&#43;00:00" />
<meta itemprop="wordCount" content="665">



<meta itemprop="keywords" content="C#,dependency injection,fakeiteasy,mocking,unit testing,unity," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Create an auto-mocking container with Unity and FakeItEasy"/>
<meta name="twitter:description" content="Unit testing can be tedious sometimes, especially when testing classes that have complex dependencies. Fortunately, some tools make it somewhat easier. I’ve been using FakeItEasy a lot recently; it’s a very easy to use mocking framework for .NET. It has a very lean and simple API based on generics and lambda expressions, and is a real pleasure to work with. It came as a breath of fresh air compared to the old RhinoMocks I had been using before."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://blog2.thomaslevesque.net/" class="f3 fw2 hover-white no-underline white-90 dib">
      Thomas Levesque .NET Blog
    </a>
    <div class="flex-l items-center">
      

      
      














    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://blog2.thomaslevesque.net/2015/06/14/create-an-auto-mocking-container-with-unity-and-fakeiteasy/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://blog2.thomaslevesque.net/2015/06/14/create-an-auto-mocking-container-with-unity-and-fakeiteasy/&amp;text=Create%20an%20auto-mocking%20container%20with%20Unity%20and%20FakeItEasy" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog2.thomaslevesque.net/2015/06/14/create-an-auto-mocking-container-with-unity-and-fakeiteasy/&amp;title=Create%20an%20auto-mocking%20container%20with%20Unity%20and%20FakeItEasy" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>

      <h1 class="f1 athelas mt3 mb1">Create an auto-mocking container with Unity and FakeItEasy</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2015-06-14T20:00:47Z">June 14, 2015</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>Unit testing can be tedious sometimes, especially when testing classes that have complex dependencies. Fortunately, some tools make it somewhat easier. I’ve been using <a href="https://github.com/FakeItEasy/FakeItEasy">FakeItEasy</a> a lot recently; it’s a very easy to use mocking framework for .NET. It has a very lean and simple API based on generics and lambda expressions, and is a real pleasure to work with. It came as a breath of fresh air compared to the old RhinoMocks I had been using before.</p>
<p>But as nice as FakeItEasy is, the process of registering all the fake dependencies for the class you are testing is still a bit tedious. Wouldn’t it be nice if the IoC container could automatically create the fakes on demand ? So this code:</p>
<pre><code>
var container = new UnityContainer();

// Setup dependencies
var fooProvider = A.Fake&lt;IFooProvider&gt;();
container.RegisterInstance(fooProvider);
var barService = A.Fake&lt;IBarService&gt;();
container.RegisterInstance(barService);
var bazManager = A.Fake&lt;IBazManager&gt;();
container.RegisterInstance(bazManager);

var sut = container.Resolve&lt;SystemUnderTest&gt;();
</code></pre><p>Could be reduced to this:</p>
<pre><code>
var container = new UnityContainer();

// This will cause the container to provide fakes for all dependencies
container.AddNewExtension&lt;AutoFakeExtension&gt;();

var sut = container.Resolve&lt;SystemUnderTest&gt;();
</code></pre><p>Well, it’s actually pretty easy to do with Unity. Unity is usually not considered the “cool kid” in the small world of IoC containers, but it’s well supported, easy to use, and extensible. I came up with the following extension to enable the above scenario:</p>
<pre><code>
public class AutoFakeExtension : UnityContainerExtension
{
    protected override void Initialize()
    {
        Context.Strategies.AddNew&lt;AutoFakeBuilderStrategy&gt;(UnityBuildStage.PreCreation);
    }
    
    private class AutoFakeBuilderStrategy : BuilderStrategy
    {
        private static readonly MethodInfo _fakeGenericDefinition;
    
        static AutoFakeBuilderStrategy()
        {
            _fakeGenericDefinition = typeof(A).GetMethod(&quot;Fake&quot;, Type.EmptyTypes);
        }
        
        public override void PreBuildUp(IBuilderContext context)
        {
            if (context.Existing == null)
            {
                var type = context.BuildKey.Type;
                if (type.IsInterface || type.IsAbstract)
                {
                    var fakeMethod = _fakeGenericDefinition.MakeGenericMethod(type);
                    var fake = fakeMethod.Invoke(null, new object[0]);
                    context.PersistentPolicies.Set&lt;ILifetimePolicy&gt;(new ContainerControlledLifetimeManager(), context.BuildKey);
                    context.Existing = fake;
                    context.BuildComplete = true;
                }
            }
            base.PreBuildUp(context);
        }
    }
}
</code></pre><p>A few comments on this code:</p>
<ul>
<li>The logic is a bit crude (it generates fakes only for interfaces and abstract classes), but can easily be adjusted if necessary.</li>
<li>The ugly reflection hack is due to the fact that FakeItEasy doesn’t have an non-generic overload of <code>A.Fake</code> that accepts a <code>Type</code> as a parameter. Well, nobody’s perfect…</li>
<li>The lifetime is set to “container controlled”, because if you need to configure method calls, you will need to access the same instance that is injected into the system under test:</li>
</ul>
<pre><code>
var fooProvider = container.Resolve&lt;IFooProvider&gt;();
A.CallTo(() =&gt; fooProvider.GetFoo(42)).Returns(new Foo { Id = 42, Name = “test” });
</code></pre><p>Note that if you register a dependency explicitly, it will take precedence and no fake will be created. So you can use this extension and still be able to manually specify a dependency:</p>
<pre><code>
var container = new UnityContainer();
container.AddNewExtension&lt;AutoFakeExtension&gt;();
container.RegisterType&lt;IFooProvider, TestFooProvider&gt;();
var sut = container.Resolve&lt;SystemUnderTest&gt;();
</code></pre><p>Of course, this extension could easily be modified to use a different mocking framework. I guess the same principle could be applied to other IoC containers as well, as long as they have suitable extension points.</p>
<h3 id="what-about-autofixture">What about AutoFixture?</h3>
<p>Before you ask: yes, I know about <a href="https://github.com/AutoFixture/AutoFixture">AutoFixture</a>. It’s a pretty good library, and I actually tried to use it as well, with some success. The resulting code is very similar to the examples above. The main reason why I didn’t keep using it is that AutoFixture is not really an IoC container (though it does some of the things an IoC container does), and I prefer to use the same IoC mechanism in my unit tests and in the actual application. Also, I’m not very comfortable with the way it handles properties when creating an instance of the SUT. By default, it sets all public writable properties to dummy instances of their type; this is fine if those properties are used for dependency injection, but IMO it doesn’t make sense for other properties. I know I can suppress this behavior for specific properties, but I have to do it manually on a case by case basis; it doesn’t take IoC container specific attributes like <code>[Dependency]</code> into account. So eventually I found it easier to use my custom Unity extension.</p>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/c" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">C#</a>
   </li>
  
   <li class="list">
     <a href="/tags/dependency-injection" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">dependency injection</a>
   </li>
  
   <li class="list">
     <a href="/tags/fakeiteasy" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">fakeiteasy</a>
   </li>
  
   <li class="list">
     <a href="/tags/mocking" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">mocking</a>
   </li>
  
   <li class="list">
     <a href="/tags/unit-testing" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">unit testing</a>
   </li>
  
   <li class="list">
     <a href="/tags/unity" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">unity</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/2015/02/01/async-unit-tests-with-nunit/">Async unit tests with NUnit</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2014/11/02/easy-unit-testing-of-null-argument-validation/">Easy unit testing of null argument validation</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2015/06/04/async-and-cancellation-support-for-wait-handles/">Async and cancellation support for wait handles</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2015/03/10/c-puzzle-1/">C# Puzzle 1</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2014/12/07/optimize-toarray-and-tolist-by-providing-the-number-of-elements/">Optimize ToArray and ToList by providing the number of elements</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2014/11/23/easily-convert-file-sizes-to-human-readable-form/">Easily convert file sizes to human-readable form</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2014/11/04/passing-parameters-by-reference-to-an-asynchronous-method/">Passing parameters by reference to an asynchronous method</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2013/11/04/showing-result-suggestions-in-a-winrt-searchbox-bug-regarding-the-image/">Showing result suggestions in a WinRT SearchBox: bug regarding the image</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2013/04/21/detecting-dependency-property-changes-in-winrt/">Detecting dependency property changes in WinRT</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2011/09/02/tail-recursion-in-c/">Tail recursion in C#</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2010/05/17/c-a-simple-implementation-of-the-weakevent-pattern/">[C#] A simple implementation of the WeakEvent pattern</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2010/02/21/automating-null-checks-with-linq-expressions/">Automating null checks with Linq expressions</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2009/06/12/c-parentchild-relationship-and-xml-serialization/">[C#] Parent/child relationship and XML serialization</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://blog2.thomaslevesque.net/" >
    &copy;  Thomas Levesque .NET Blog 2020 
  </a>
    <div>













</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
