<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>How to retrieve dates as UTC in SQLite - Thomas Levesque&#39;s .NET Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-31621259-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Thomas Levesque&#39;s .NET Blog" rel="home">
				<div class="logo__title">Thomas Levesque&#39;s .NET Blog</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">How to retrieve dates as UTC in SQLite</h1>
			
		</header><div class="content post__content clearfix">
			<p><a href="http://sqlite.org/">SQLite</a> is a nice in-process database engine: it’s very lightweight, doesn’t require any server or configuration, and runs on all platforms. There is even an <a href="http://system.data.sqlite.org/">official ADO.NET provider</a> that’s very well made. However, if you store dates as UTC with this provider, you will probably encounter a serious issue: even though the date is properly stored as UTC (it’s stored in a form similar to ISO8601, with a ‘Z’ to indicate the UTC timezone), when you read it back from the database, you will get a <code>DateTime</code> converted to local time, with <code>Kind</code> = <code>Unspecified</code>. Here’s an example that exhibits the problem (using <a href="https://github.com/StackExchange/dapper-dot-net">Dapper</a> in <a href="http://www.linqpad.net/">LINQPad</a>):</p>
<pre><code>void Main()
{
    string connectionString = @&quot;Data Source=D:\tmp\testSQLiteDate.db&quot;;
    using (var connection = new SQLiteConnection(connectionString))
    {
        connection.Open();
        connection.Execute(&quot;create table Foo(Id integer not null primary key, CreationDateUtc datetime not null)&quot;);
        
        var foo = new Foo{Id = 42, CreationDateUtc = DateTime.UtcNow};
        foo.Dump(&quot;Original object&quot;);
        connection.Execute(&quot;insert into Foo(Id, CreationDateUtc) values (@Id, @CreationDateUtc)&quot;, foo);
        var foo2 = connection.Query&lt;Foo&gt;(&quot;select * from Foo where Id = @Id&quot;, new{ Id = 42 }).SingleOrDefault();
        foo2.Dump(&quot;After reading from DB&quot;);
    }
}

class Foo
{
    public int Id { get; set; }
    public DateTime CreationDateUtc { get; set; }
    public DateTimeKind Kind { get { return CreationDateUtc.Kind; } }
}
</code></pre><p>Here’s the output:</p>
<p><img src="image.png" alt="image" title="image"></p>
<p>As you can see, after reading it from the database, the date is no longer in UTC, and doesn’t even contain an indication that it’s a local date. This can cause all kinds of bugs if your code is comparing dates that are supposed to be UTC.</p>
<p>I initially tried to fix that in my code by manually converting the date, before I realized that the solution was much simpler (although <a href="http://www.nudoq.org/#!/Packages/System.Data.SQLite/System.Data.SQLite/SQLiteConnectionStringBuilder/P/DateTimeKind">not very well documented</a>): there is a connection string setting to control how dates are handled. You just need to specify <code>DateTimeKind=Utc</code> in your connection string:</p>
<pre><code>string connectionString = @&quot;Data Source=D:\tmp\testSQLiteDate.db;DateTimeKind=Utc&quot;;
</code></pre><p>If you’re using <code>SqliteConnectionStringBuilder</code> to build the connection string, just set the <code>DateTimeKind</code> property to <code>DateTimeKind.Utc</code>.</p>
<p>As you can see, the date kind is now preserved:</p>
<p><img src="image1.png" alt="image" title="image"></p>
<p><strong>Important caveat:</strong> this setting will apply to <strong>all</strong> dates read from this connection. If you have dates that were not stored as UTC, the provider will assume that they are UTC dates anyway, which will produce incorrect results. So, only do this if you store all dates as UTC.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/ado.net/" rel="tag">ado.net</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/c/" rel="tag">C#</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/datetime/" rel="tag">datetime</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/sqlite/" rel="tag">sqlite</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/system.data.sqlite/" rel="tag">system.data.sqlite</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/utc/" rel="tag">utc</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>





			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 Thomas Levesque&#39;s .NET Blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>