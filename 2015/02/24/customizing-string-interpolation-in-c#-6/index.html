<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Customizing string interpolation in C# 6 | Thomas Levesque .NET Blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.69.2" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.1cb140d8ba31d5b2f1114537dd04802a.css" rel="stylesheet">
    

    

    
      
    

    
    
    <meta property="og:title" content="Customizing string interpolation in C# 6" />
<meta property="og:description" content="One of the major new features in C# 6 is string interpolation, which allows you to write things like this:
 string text = $&quot;{p.Name} was born on {p.DateOfBirth:D}&quot;;A lesser known aspect of this feature is that an interpolated string can be treated either as a String, or as an IFormattable, depending on the context. When it is converted to an IFormattable, it constructs a FormattableString object that implements the interface and exposes:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog2.thomaslevesque.net/2015/02/24/customizing-string-interpolation-in-c#-6/" />
<meta property="article:published_time" content="2015-02-24T02:00:00+00:00" />
<meta property="article:modified_time" content="2015-02-24T02:00:00+00:00" />
<meta itemprop="name" content="Customizing string interpolation in C# 6">
<meta itemprop="description" content="One of the major new features in C# 6 is string interpolation, which allows you to write things like this:
 string text = $&quot;{p.Name} was born on {p.DateOfBirth:D}&quot;;A lesser known aspect of this feature is that an interpolated string can be treated either as a String, or as an IFormattable, depending on the context. When it is converted to an IFormattable, it constructs a FormattableString object that implements the interface and exposes:">
<meta itemprop="datePublished" content="2015-02-24T02:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2015-02-24T02:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1111">



<meta itemprop="keywords" content="C# 6,iformattable,roslyn,string interpolation," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Customizing string interpolation in C# 6"/>
<meta name="twitter:description" content="One of the major new features in C# 6 is string interpolation, which allows you to write things like this:
 string text = $&quot;{p.Name} was born on {p.DateOfBirth:D}&quot;;A lesser known aspect of this feature is that an interpolated string can be treated either as a String, or as an IFormattable, depending on the context. When it is converted to an IFormattable, it constructs a FormattableString object that implements the interface and exposes:"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://blog2.thomaslevesque.net/" class="f3 fw2 hover-white no-underline white-90 dib">
      Thomas Levesque .NET Blog
    </a>
    <div class="flex-l items-center">
      

      
      














    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://blog2.thomaslevesque.net/2015/02/24/customizing-string-interpolation-in-c" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://blog2.thomaslevesque.net/2015/02/24/customizing-string-interpolation-in-c&amp;text=Customizing%20string%20interpolation%20in%20C#%206" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog2.thomaslevesque.net/2015/02/24/customizing-string-interpolation-in-c&amp;title=Customizing%20string%20interpolation%20in%20C#%206" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>

      <h1 class="f1 athelas mt3 mb1">Customizing string interpolation in C# 6</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2015-02-24T02:00:00Z">February 24, 2015</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>One of the major new features in C# 6 is string interpolation, which allows you to write things like this:</p>
<pre><code>
string text = $&quot;{p.Name} was born on {p.DateOfBirth:D}&quot;;
</code></pre><p>A lesser known aspect of this feature is that an interpolated string can be treated either as a <code>String</code>, or as an <code>IFormattable</code>, depending on the context. When it is converted to an <code>IFormattable</code>, it constructs a <code>FormattableString</code> object that implements the interface and exposes:</p>
<ul>
<li>the format string with the placeholders (“holes”) replaced by numbers (compatible with <code>String.Format</code>)</li>
<li>the values for the placeholders</li>
</ul>
<p>The <code>ToString()</code> method of this object just calls <code>String.Format(format, values)</code>. ``But there is also an overload that accepts an <code>IFormatProvider</code>, and this is where things get interesting, because it makes it possible to customize how the values are formatted. It might not be immediately obvious why this is useful, so let me give you a few examples…</p>
<h3 id="specifying-the-culture">Specifying the culture</h3>
<p>During the design of the string interpolation feature, there was a lot of debate on whether to use the current culture or the invariant culture to format the values; there were good arguments on both sides, but eventually it was decided to use the current culture, for consistency with <code>String.Format</code> and similar APIs that use <a href="https://msdn.microsoft.com/en-us/library/txafckwd.aspx">composite formatting</a>. Using the current culture makes sense when you’re using string interpolation to build strings to be displayed in the user interface; but there are also scenarios where you want to build strings that will be consumed by an API or protocol (URLs, SQL queries…), and in those cases you usually want to use the invariant culture.</p>
<p>C# 6 provides an easy way to do that, by taking advantage of the conversion to <code>IFormattable</code>. You just need to create a method like this:</p>
<pre><code>
static string Invariant(FormattableString formattable)
{
    return formattable.ToString(CultureInfo.InvariantCulture);
}
</code></pre><p>And you can then use it as follows:</p>
<pre><code>
string text = Invariant($&quot;{p.Name} was born on {p.DateOfBirth:D}&quot;);
</code></pre><p>The values in the interpolated strings will now be formatted with the invariant culture, rather than the default culture.</p>
<h3 id="building-urls">Building URLs</h3>
<p>Here’s a more advanced example. String interpolation is a convenient way to build URLs, but if you include arbitrary strings in a URL, you need to be careful to URL-encode them. A custom string interpolator can do that for you; you just need to create a custom <code>IFormatProvider</code> that will take care of encoding the values. The implementation was not obvious at first, but after some trial and error I came up with this:</p>
<pre><code>
class UrlFormatProvider : IFormatProvider
{
    private readonly UrlFormatter _formatter = new UrlFormatter();

    public object GetFormat(Type formatType)
    {
        if (formatType == typeof(ICustomFormatter))
            return _formatter;
        return null;
    }

    class UrlFormatter : ICustomFormatter
    {
        public string Format(string format, object arg, IFormatProvider formatProvider)
        {
            if (arg == null)
                return string.Empty;
            if (format == &quot;r&quot;)
                return arg.ToString();
            return Uri.EscapeDataString(arg.ToString());
        }
    }
}
</code></pre><p>You can use the formatter like this:</p>
<pre><code>
static string Url(FormattableString formattable)
{
    return formattable.ToString(new UrlFormatProvider());
}

...

string url = Url($&quot;http://foobar/item/{id}/{name}&quot;);
</code></pre><p>It will correctly encode the values of <code>id</code> and <code>name</code> so that the resulting URL only contains valid characters.</p>
<p><em>Aside: Did you notice the if <code>(format == &quot;r&quot;)</code>? It’s a custom format specifier to indicate that the value should not be encoded (“r” stands for “raw”). To use it you just include it in the format string like this: <code>{id:r}</code>. This will prevent the encoding of <code>id</code>.</em></p>
<h3 id="building-sql-queries">Building SQL queries</h3>
<p>You can do something similar for SQL queries. Of course, it’s a known bad practice to embed values directly in the query, for security and performance reasons (you should use parameterized queries instead); but for “quick and dirty” developments it can still be useful. And anyway, it’s a good illustration for the feature. When embedding values in a SQL queries, you should:</p>
<ul>
<li>enclose strings in single quotes, and escape single quotes inside the strings by doubling them</li>
<li>format dates according to what the DBMS expects (typically MM/dd/yyyy)</li>
<li>format numbers using the invariant culture</li>
<li>replace null values with the <code>NULL</code> literal</li>
</ul>
<p>(there are probably other things to take care of, but these are the most obvious).</p>
<p>We can use the same approach as for URLs and create a <code>SqlFormatProvider</code>:</p>
<pre><code>
class SqlFormatProvider : IFormatProvider
{
    private readonly SqlFormatter _formatter = new SqlFormatter();

    public object GetFormat(Type formatType)
    {
        if (formatType == typeof(ICustomFormatter))
            return _formatter;
        return null;
    }

    class SqlFormatter : ICustomFormatter
    {
        public string Format(string format, object arg, IFormatProvider formatProvider)
        {
            if (arg == null)
                return &quot;NULL&quot;;
            if (arg is string)
                return &quot;'&quot; + ((string)arg).Replace(&quot;'&quot;, &quot;''&quot;) + &quot;'&quot;;
            if (arg is DateTime)
                return &quot;'&quot; + ((DateTime)arg).ToString(&quot;MM/dd/yyyy&quot;) + &quot;'&quot;;
            if (arg is IFormattable)
                return ((IFormattable)arg).ToString(format, CultureInfo.InvariantCulture);
            return arg.ToString();
        }
    }
}
</code></pre><p>You can then use the formatter like this:</p>
<pre><code>
static string Sql(FormattableString formattable)
{
    return formattable.ToString(new SqlFormatProvider());
}

...

string sql = Sql($&quot;insert into items(id, name, creationDate) values({id}, {name}, {DateTime.Now})&quot;);
</code></pre><p>This will take care of properly formatting the values to produce a valid SQL query.</p>
<h3 id="using-string-interpolation-when-targeting-older-versions-of-net">Using string interpolation when targeting older versions of .NET</h3>
<p>As is often the case for language features that leverage .NET framework types, you can use this feature with older versions of the framework that don’t have the <code>FormattableString</code> class; you just have to create the class yourself in the appropriate namespace. Actually, there are two classes to implement: <code>FormattableString</code> and <code>FormattableStringFactory</code>. <a href="https://twitter.com/jonskeet/status/569973023064887296">Jon Skeet was apparently in a hurry to try this</a>, and he has already <a href="https://gist.github.com/jskeet/9d297d0dc013d7a557ee">provided an example</a> with the code for these classes:</p>
<pre><code>
using System;

namespace System.Runtime.CompilerServices
{
    public class FormattableStringFactory
    {
        public static FormattableString Create(string messageFormat, params object[] args)
        {
            return new FormattableString(messageFormat, args);
        }

        public static FormattableString Create(string messageFormat, DateTime bad, params object[] args)
        {
            var realArgs = new object[args.Length + 1];
            realArgs[0] = &quot;Please don't use DateTime&quot;;
            Array.Copy(args, 0, realArgs, 1, args.Length);
            return new FormattableString(messageFormat, realArgs);
        }
    }
}

namespace System
{
    public class FormattableString
    {
        private readonly string messageFormat;
        private readonly object[] args;

        public FormattableString(string messageFormat, object[] args)
        {
            this.messageFormat = messageFormat;
            this.args = args;
        }
        public override string ToString()
        {
            return string.Format(messageFormat, args);
        }
    }
}
</code></pre><p>This is the same approach that made it possible to use Linq when targeting .NET 2 (<a href="http://www.albahari.com/nutshell/linqbridge.aspx">LinqBridge</a>) or <a href="http://www.thomaslevesque.com/2012/06/13/using-c-5-caller-info-attributes-when-targeting-earlier-versions-of-the-net-framework/">caller info attributes when targeting .NET 4</a> or earlier. Of course, it still requires the C# 6 compiler to work…</p>
<h3 id="conclusion">Conclusion</h3>
<p>The conversion of interpolated strings to <code>IFormattable</code> <a href="https://roslyn.codeplex.com/discussions/570614">had been mentioned previously</a>, but it wasn’t implemented until recently; the <a href="http://blogs.msdn.com/b/visualstudio/archive/2015/02/23/visual-studio-2015-ctp-6-and-team-foundation-server-2015-ctp-released.aspx">just released CTP 6 of Visual Studio 2015</a> ships with a new version of the compiler that includes this feature, so you can now go ahead and use it. This feature makes string interpolation very flexible, and I’m sure people will come up with many other use cases that I didn’t think of.</p>
<p>You can find the code for the examples above <a href="https://github.com/thomaslevesque/blog-code-samples/tree/master/TestStringInterpolation">on GitHub</a>.</p>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/c#-6" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">C# 6</a>
   </li>
  
   <li class="list">
     <a href="/tags/iformattable" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">iformattable</a>
   </li>
  
   <li class="list">
     <a href="/tags/roslyn" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">roslyn</a>
   </li>
  
   <li class="list">
     <a href="/tags/string-interpolation" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">string interpolation</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/2014/11/17/stringtemplate-another-approach-to-string-interpolation/">StringTemplate: another approach to string interpolation</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://blog2.thomaslevesque.net/" >
    &copy;  Thomas Levesque .NET Blog 2020 
  </a>
    <div>













</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
