<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Weak events in C#, take two - Thomas Levesque&#39;s .NET Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-31621259-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Thomas Levesque&#39;s .NET Blog" rel="home">
				<div class="logo__title">Thomas Levesque&#39;s .NET Blog</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Weak events in C#, take two</h1>
			
		</header><div class="content post__content clearfix">
			<p>A few years ago, I blogged about a <a href="http://www.thomaslevesque.com/2010/05/17/c-a-simple-implementation-of-the-weakevent-pattern/">generic implementation of the weak event pattern in C#</a>. The goal was to mitigate the memory leaks associated with events when you forget to unsubscribe. The implementation was based on the use of weak references to the subscribers, to allow them to be garbage collected.</p>
<p>My initial solution was more a proof of concept than anything else, and had a major performance issue, due to the use of <code>DynamicInvoke</code> every time the event was raised. Over the years, I revisited the weak event problem several times and came up with various solutions, improving a little every time, and I now have an implementation that should be good enough for most use cases. The public API is similar to that of my first solution. Basically, instead of writing an event like this:</p>
<pre><code>public event EventHandler MyEvent;
</code></pre><p>You write it like this:</p>
<pre><code>private readonly WeakEventSource _myEventSource = new WeakEventSource();
public event EventHandler MyEvent
{
    add { _myEventSource.Subscribe(value); }
    remove { _myEventSource.Unsubscribe(value); }
}
</code></pre><p>From the subscriber’s point of view, this is no different from a normal event, but the subscriber will be eligible to garbage collection if it’s not referenced anywhere else.</p>
<p>The event publisher can raise the event like this:</p>
<pre><code>_myEventSource.Raise(this, e);
</code></pre><p>There is a small limitation: the signature of the event <em>has</em> to be <code>EventHandler&lt;TEventArgs&gt;</code> (with any <code>TEventArgs</code> you like, of course). It can’t be something like <code>FooEventHandler</code>, or a custom delegate type. I don’t think this is a major issue, because the vast majority of events in the .NET world follow the recommended pattern <code>void (sender, args)</code>, and specific delegate types like <code>FooEventHandler</code> actually have the same signature as <code>EventHandler&lt;FooEventArgs&gt;</code>. I initially tried to make a solution that could work with any delegate signature, but it turned out to be too much of a challenge… for now at least <img src="wlEmoticon-winkingsmile.png" alt="Winking smile">.</p>
<h3 id="how-does-it-work">How does it work</h3>
<p>This new solution is still based on weak references, but changes the way the target method is called. Rather than using <code>DynamicInvoke</code>, it creates an open-instance delegate for the method when the weak handler is subscribed. What this means is that for an event signature like <code>void EventHandler(object sender, EventArgs e)</code>,  it creates a delegate with the signature <code>void OpenEventHandler(object target, object sender, EventArgs e)</code>. The extra <code>target</code> parameter represents the instance on which the method is called. To invoke the handler, we just need to get the target from the weak reference, and if it’s still alive,  pass it to the open-instance delegate.</p>
<p>For better performance, this delegate is created only the first time a given handler method is encountered, and is cached for later reuse. This way, if multiple instances of an object subscribe to an event using the same handler method, the delegate is only created the first time, and is reused for subsequent subscribers.</p>
<p>Note that technically, the created delegate is not a “real” open-instance delegate such as those created with <code>Delegate.CreateDelegate</code>. Instead it is created using Linq expressions. The reason is that in a real open-instance delegate, the type of the first parameter must be the type that declares the method, rather than object. Since this information isn’t known statically, I have to dynamically introduce a cast.</p>
<p>You can find the source code on GitHub: <a href="https://github.com/thomaslevesque/WeakEvent">WeakEvent</a>. A NuGet package is available here: <a href="https://www.nuget.org/packages/ThomasLevesque.WeakEvent/">ThomasLevesque.WeakEvent</a>.</p>
<p>The repository also include code snippets for <a href="https://github.com/thomaslevesque/WeakEvent/blob/master/Snippets/VisualStudio/wevt.snippet">Visual Studio</a> and <a href="https://github.com/thomaslevesque/WeakEvent/blob/master/Snippets/ReSharper/wevt.DotSettings">ReSharper</a>, to make it easier to write the boilerplate code for a weak event.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/events/" rel="tag">events</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/memory-leak/" rel="tag">memory leak</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/open-instance-delegate/" rel="tag">open-instance delegate</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/weak-event/" rel="tag">weak event</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>





			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 Thomas Levesque&#39;s .NET Blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>