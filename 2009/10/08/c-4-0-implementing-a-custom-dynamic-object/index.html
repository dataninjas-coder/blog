<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>[C# 4.0] Implementing a custom dynamic object - Thomas Levesque&#39;s .NET Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-31621259-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Thomas Levesque&#39;s .NET Blog" rel="home">
				<div class="logo__title">Thomas Levesque&#39;s .NET Blog</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[C# 4.0] Implementing a custom dynamic object</h1>
			
		</header><div class="content post__content clearfix">
			<p>If you&rsquo;ve been following the news about .NET, you probably know that the upcoming version 4.0 of C# introduces a new <code>dynamic</code> type. This type allows to access members of an object which are not statically known (at compile time). These members will be resolved at runtime, thanks to the DLR (Dynamic Language Runtime). This feature makes it easier to manipulate COM objects, or any object which type is not statically known. You can find more information about the <code>dynamic</code> type <a href="http://msdn.microsoft.com/en-us/library/dd264736%28VS.100%29.aspx">on MSDN</a>.  While playing with Visual Studio 2010 beta, I realized this <code>dynamic</code> type enabled very interesting scenarios&hellip; It is indeed possible to create your own dynamic objects, with the ability to control the resolution of dynamic members. To do that, you need to implement the <a href="http://msdn.microsoft.com/en-us/library/system.dynamic.idynamicmetaobjectprovider%28VS.100%29.aspx"><code>IDynamicMetaObjectProvider</code></a> interface. This interface seems pretty simple at first sight, since it only defines one member: the <code>GetMetaObject</code> method. But it actually gets trickier when you try to implement this method : you have to build a <code>DynamicMetaObject</code> from an <code>Expression</code>, which is far from trivial&hellip; I must admit I almost gave up when I saw the complexity of the task.  Fortunately, there is a much easier way to create your own dynamic objects: you just have to inherit from the <code>DynamicObject</code> class, which provides a basic implementation of <code>IDynamicMetaObjectProvider</code>, and override a few methods to achieve the desired behavior.  Here&rsquo;s a simple example, inspired from the Javascript language. In Javascript, it is possible to dynamically add members (properties or methods) to an existing type, as in the following sample:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object();
<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">Message</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Hello world !&#34;</span>;
<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">ShowMessage</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>()
{
  <span style="color:#a6e22e">alert</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">Message</span>);
};
<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">ShowMessage</span>();
</code></pre></div><p>This code creates an object, add a <code>Message</code> property to that object by defining its value, and also adds a <code>ShowMessage</code> method to display the message.  In previous versions of C#, it would have been impossible to do such a thing: indeed C# is a statically typed language, which implies that members are resolved at compile time, not at runtime. Since the <code>Object</code> class doesn&rsquo;t have a <code>Message</code> property or a <code>ShowMessage</code> method, the compiler won&rsquo;t accept things like <code>x.Message</code> or <code>x.ShowMessage()</code>. This is where the <code>dynamic</code> type comes to the rescue, since it doesn&rsquo;t resolve the members at compile time&hellip;  Now let&rsquo;s try to create a dynamic object that allows to write a C# code similar to the Javascript code above. To do that, we will store the values of dynamic properties in a <code>Dictionary&lt;string, object&gt;</code>. To make this class work, we need to override the <a href="http://msdn.microsoft.com/en-us/library/system.dynamic.dynamicobject.trygetmember%28VS.100%29.aspx"><code>TryGetMember</code></a> and <a href="http://msdn.microsoft.com/en-us/library/system.dynamic.dynamicobject.trygetmember%28VS.100%29.aspx"><code>TrySetMember</code></a> methods. These methods implement the logic to read or write a member of the dynamic object. To illustrate the idea, let&rsquo;s have a look at the code, I&rsquo;ll comment it later:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyDynamicObject</span> : DynamicObject
{
    <span style="color:#66d9ef">private</span> Dictionary&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">object</span>&gt; _properties = <span style="color:#66d9ef">new</span> Dictionary&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">object</span>&gt;();

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">bool</span> TryGetMember(GetMemberBinder binder, <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">object</span> result)
    {
        <span style="color:#66d9ef">return</span> _properties.TryGetValue(binder.Name, <span style="color:#66d9ef">out</span> result);
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">bool</span> TrySetMember(SetMemberBinder binder, <span style="color:#66d9ef">object</span> <span style="color:#66d9ef">value</span>)
    {
        _properties[binder.Name] = <span style="color:#66d9ef">value</span>;
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
    }
}
</code></pre></div><p>Now let&rsquo;s explain the code above. The <code>TryGetMember</code> tries to find the requested property in the dictionary. Note that the name of the property is exposed as the <code>Name</code> property of the <code>binder</code> parameter. If the property exists, its value is returned in the <code>result</code> output parameter, and the method returns <code>true</code>. Otherwise, the method returns <code>false</code>, which will cause a <code>RuntimeBinderException</code> at the call site. This exception simply means that the dynamic resolution of the property failed.  The <code>TrySetMember</code> method performs the opposite task: it defines the value of a property. If the member doesn&rsquo;t exist, it is added to the dictionary, so the method always returns <code>true</code>.  The following sample shows how to use this object:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">dynamic</span> x = <span style="color:#66d9ef">new</span> MyDynamicObject();
x.Message = <span style="color:#e6db74">&#34;Hello world !&#34;</span>;
Console.WriteLine(x.Message);
</code></pre></div><p>This code compiles and runs fine, and prints &ldquo;Hello world !&rdquo; to the console&hellip; easy, isn&rsquo;t it ?  But what about methods ? Well, I could tell you that you need to override the <code>TryInvokeMember</code> method, which is used to handle dynamic method calls&hellip; but actually it&rsquo;s not even necessary ! Our implementation already handles this feature: we just need to assign a delegate to a property of the object. It won&rsquo;t actually be a real member method, just a property returning a delegate, but since the syntax to call it will be the same as a method call, it will do fine for now. Here&rsquo;s an example of adding a method to the object:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">dynamic</span> x = <span style="color:#66d9ef">new</span> MyDynamicObject();
x.Message = <span style="color:#e6db74">&#34;Hello world !&#34;</span>;
x.ShowMessage = <span style="color:#66d9ef">new</span> Action(
    () =&gt;
    {
        Console.WriteLine(x.Message);
    });
x.ShowMessage();
</code></pre></div><p>Eventually, we end up with something very close to the Javascript we were trying to imitate, all with a class of less than 10 lines of code (not counting the braces)&hellip;  This class can be quite handy to use as an general purpose object, for instance to group some data together without having to create a specific class. In that aspect, it&rsquo;s similar to an anonymous type (already existing in C# 3), but with the benefit that it can be used as a method return value, which is not possible with an anonymous type.  Of course there are many more useful things to do with a custom dynamic object&hellip; for instance, here&rsquo;s a simple wrapper for a <code>DataRow</code>, to make it easier to access the fields:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DynamicDataRow</span> : DynamicObject
{
    <span style="color:#66d9ef">private</span> DataRow _dataRow;

    <span style="color:#66d9ef">public</span> DynamicDataRow(DataRow dataRow)
    {
        <span style="color:#66d9ef">if</span> (dataRow == <span style="color:#66d9ef">null</span>)
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(<span style="color:#e6db74">&#34;dataRow&#34;</span>);
        <span style="color:#66d9ef">this</span>._dataRow = dataRow;
    }

    <span style="color:#66d9ef">public</span> DataRow DataRow
    {
        <span style="color:#66d9ef">get</span> { <span style="color:#66d9ef">return</span> _dataRow; }
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">bool</span> TryGetMember(GetMemberBinder binder, <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">object</span> result)
    {
        result = <span style="color:#66d9ef">null</span>;
        <span style="color:#66d9ef">if</span> (_dataRow.Table.Columns.Contains(binder.Name))
        {
            result = _dataRow[binder.Name];
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
        }
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">bool</span> TrySetMember(SetMemberBinder binder, <span style="color:#66d9ef">object</span> <span style="color:#66d9ef">value</span>)
    {
        <span style="color:#66d9ef">if</span> (_dataRow.Table.Columns.Contains(binder.Name))
        {
            _dataRow[binder.Name] = <span style="color:#66d9ef">value</span>;
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
        }
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
    }
}
</code></pre></div><p>Let&rsquo;s add a helper extension method to get the wrapper for a row:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DynamicDataRowExtensions</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">dynamic</span> AsDynamic(<span style="color:#66d9ef">this</span> DataRow dataRow)
    {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> DynamicDataRow(dataRow);
    }
}
</code></pre></div><p>We can now write things like that:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">DataTable table = <span style="color:#66d9ef">new</span> DataTable();
table.Columns.Add(<span style="color:#e6db74">&#34;FirstName&#34;</span>, <span style="color:#66d9ef">typeof</span>(<span style="color:#66d9ef">string</span>));
table.Columns.Add(<span style="color:#e6db74">&#34;LastName&#34;</span>, <span style="color:#66d9ef">typeof</span>(<span style="color:#66d9ef">string</span>));
table.Columns.Add(<span style="color:#e6db74">&#34;DateOfBirth&#34;</span>, <span style="color:#66d9ef">typeof</span>(DateTime));

<span style="color:#66d9ef">dynamic</span> row = table.NewRow().AsDynamic();
row.FirstName = <span style="color:#e6db74">&#34;John&#34;</span>;
row.LastName = <span style="color:#e6db74">&#34;Doe&#34;</span>;
row.DateOfBirth = <span style="color:#66d9ef">new</span> DateTime(<span style="color:#ae81ff">1981</span>, <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">12</span>);
table.Rows.Add(row.DataRow);

<span style="color:#75715e">// Add more rows...
</span><span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">var</span> bornInThe20thCentury = <span style="color:#66d9ef">from</span> r <span style="color:#66d9ef">in</span> table.AsEnumerable()
                           <span style="color:#66d9ef">let</span> dr = r.AsDynamic()
                           <span style="color:#66d9ef">where</span> dr.DateOfBirth.Year &gt; <span style="color:#ae81ff">1900</span>
                           &amp;&amp; dr.DateOfBirth.Year &lt;= <span style="color:#ae81ff">2000</span>
                           <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">new</span> { dr.LastName, dr.FirstName };

<span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> item <span style="color:#66d9ef">in</span> bornInThe20thCentury)
{
    Console.WriteLine(<span style="color:#e6db74">&#34;{0} {1}&#34;</span>, item.FirstName, item.LastName);
}
</code></pre></div><p>Now that you understand the basic principles for creating custom dynamic objects, you can imagine many more useful applications :)  <strong>Update :</strong> Just after posting this article, I stumbled upon the <a href="http://msdn.microsoft.com/en-us/library/system.dynamic.expandoobject%28VS.100%29.aspx"><code>ExpandoObject</code></a> class, which does exactly the same thing as the <code>MyDynamicObject</code> class above&hellip; It seems I reinvented the wheel again ;). Anyway, it&rsquo;s interesting to see how dynamic objects work internally, if only for learning purposes&hellip; For more details about the <code>ExpandoObject</code> class, check out <a href="http://blogs.msdn.com/csharpfaq/archive/2009/10/01/dynamic-in-c-4-0-introducing-the-expandoobject.aspx">this post on the C# FAQ blog</a>.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/.net-4.0/" rel="tag">.NET 4.0</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/c#-4.0/" rel="tag">C# 4.0</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/dlr/" rel="tag">DLR</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/dynamic/" rel="tag">dynamic</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>





			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 Thomas Levesque&#39;s .NET Blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>