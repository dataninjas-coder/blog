<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Showing result suggestions in a WinRT SearchBox: bug regarding the image - Thomas Levesque&#39;s .NET Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-31621259-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Thomas Levesque&#39;s .NET Blog" rel="home">
				<div class="logo__title">Thomas Levesque&#39;s .NET Blog</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Showing result suggestions in a WinRT SearchBox: bug regarding the image</h1>
			
		</header><div class="content post__content clearfix">
			<p>Today I ran into a strange problem that made me waste an hour or two, so I thought I’d write about it in case someone else faces the same issue.</p>
<p>The <a href="http://msdn.microsoft.com/library/windows/apps/dn252771"><code>SearchBox</code></a> control was introduced in Windows 8.1 to enable search scenarios from within a Windows Store app. One of its features is that it can show suggestions based on user input. There are three kinds of suggestions:</p>
<ul>
<li>History suggestions are search queries previously entered by the user. This is handled automatically, so you don’t need to write any code for it to work.</li>
<li>Search suggestions allow you to provide search terms based on user input; if the user selects one, the current query text will be replaced with the text of the suggestion, and submitting the query will start the search.</li>
<li>Result suggestions are suggestions for exact results. The user can select one of these results directly without actually starting a full search.</li>
</ul>
<p>To provide suggestions, you need to handle the <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.controls.searchbox.suggestionsrequested"><code>SuggestionsRequested</code></a> event of the <code>SearchBox</code>, and add suggestions using the <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.applicationmodel.search.searchsuggestioncollection.appendquerysuggestion"><code>AppendQuerySuggestion</code></a> and <a href="http://msdn.microsoft.com/en-us/library/windows/apps/hh700542"><code>AppendResultSuggestion</code></a> methods. Let’s focus on result suggestions.</p>
<p>The <code>AppendResultSuggestion</code> method takes several parameters, and one of them is the image to display for the suggestion. It is mandatory (passing null will throw an exception), and the parameter is of type <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.storage.streams.irandomaccessstreamreference"><code>IRandomAccessStreamReference</code></a>, i.e. something that can provide a stream. I find this a little peculiar, since it would be more natural to pass an <code>ImageSource</code>, but that’s the way it is… So I looked for a class that implements the <code>IRandomAccessStreamReference</code> interface, and the first obvious candidate I found was <code>StorageFile</code>, which represents a file. So I wrote the following code:</p>
<pre><code>private async void SearchBox_SuggestionsRequested(SearchBox sender, SearchBoxSuggestionsRequestedEventArgs args)
{
    var deferral = args.Request.GetDeferral();
    try
    {
        var imageUri = new Uri(&quot;ms-appx:///test.png&quot;);
        var imageRef = await StorageFile.GetFileFromApplicationUriAsync(imageUri);
        args.Request.SearchSuggestionCollection.AppendQuerySuggestion(&quot;test&quot;);
        args.Request.SearchSuggestionCollection.AppendSearchSeparator(&quot;Foo Bar&quot;);
        args.Request.SearchSuggestionCollection.AppendResultSuggestion(&quot;foo&quot;, &quot;Details&quot;, &quot;foo&quot;, imageRef, &quot;Result&quot;);
        args.Request.SearchSuggestionCollection.AppendResultSuggestion(&quot;bar&quot;, &quot;Details&quot;, &quot;bar&quot;, imageRef, &quot;Result&quot;);
        args.Request.SearchSuggestionCollection.AppendResultSuggestion(&quot;baz&quot;, &quot;Details&quot;, &quot;baz&quot;, imageRef, &quot;Result&quot;);
    }
    finally
    {
        deferral.Complete();
    }
}
</code></pre><p>This code runs without any error, and the suggestions are displayed… but the image is not shown!</p>
<p><img src="BiF0g.png" alt="http://i.stack.imgur.com/BiF0g.png"></p>
<p>I spent a long time double-checking everything, making lots of minor changes to try and locate the issue, I even wrote a custom implementation of <code>IRandomAccessStreamReference</code>… to no avail.</p>
<p>I eventually <a href="http://stackoverflow.com/questions/19769689/image-not-shown-for-result-suggestions-in-searchbox">submitted the problem to Stack Overflow</a>, and someone kindly provided the solution, which was very simple: instead of <code>StorageFile</code>, use <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.storage.streams.randomaccessstreamreference"><code>RandomAccessStreamReference</code></a> (seems pretty obvious once you know that it exists). The code now becomes :</p>
<pre><code>private void SearchBox_SuggestionsRequested(SearchBox sender, SearchBoxSuggestionsRequestedEventArgs args)
{
    var imageUri = new Uri(&quot;ms-appx:///test.png&quot;);
    var imageRef = RandomAccessStreamReference.CreateFromUri(imageUri);
    args.Request.SearchSuggestionCollection.AppendQuerySuggestion(&quot;test&quot;);
    args.Request.SearchSuggestionCollection.AppendSearchSeparator(&quot;Foo Bar&quot;);
    args.Request.SearchSuggestionCollection.AppendResultSuggestion(&quot;foo&quot;, &quot;Details&quot;, &quot;foo&quot;, imageRef, &quot;Result&quot;);
    args.Request.SearchSuggestionCollection.AppendResultSuggestion(&quot;bar&quot;, &quot;Details&quot;, &quot;bar&quot;, imageRef, &quot;Result&quot;);
    args.Request.SearchSuggestionCollection.AppendResultSuggestion(&quot;baz&quot;, &quot;Details&quot;, &quot;baz&quot;, imageRef, &quot;Result&quot;);
}
</code></pre><p>(Note that the method is not asynchronous anymore, so there is no need to use the deferral object).</p>
<p>The suggestions are now displayed as expected, with the image:</p>
<p><img src="cjmogKp.png" alt="http://i.imgur.com/cjmogKp.png"></p>
<p>So, the lesson of this story is that even though the <code>image</code> parameter is of type <code>IRandomAccessStreamReference</code>, <strong>it doesn’t seem to accept anything other than an instance of the <code>RandomAccessStreamReference</code> class</strong>. If you pass any other implementation of the interface, it just fails silently and the image is not shown. This is obviously a bug: if the parameter type in the method signature is an interface, it should accept any implementation of that interface, not just a specific implementation; if it doesn’t, it should be declared of the concrete type. I submitted the <a href="https://connect.microsoft.com/VisualStudio/feedback/details/807704/searchbox-windows-8-1-doesnt-show-the-image-if-it-is-not-an-instance-of-randomaccessstreamreference">bug</a> to Connect, hopefully it will be fixed in a future version.</p>
<p>I hope this helps someone!</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/c/" rel="tag">C#</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/image/" rel="tag">image</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/searchbox/" rel="tag">searchbox</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/suggestion/" rel="tag">suggestion</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/winrt/" rel="tag">winrt</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>





			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 Thomas Levesque&#39;s .NET Blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>