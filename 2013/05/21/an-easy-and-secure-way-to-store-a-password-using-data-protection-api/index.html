<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>An easy and secure way to store a password using Data Protection API | Thomas Levesque .NET Blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.69.2" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.1cb140d8ba31d5b2f1114537dd04802a.css" rel="stylesheet">
    

    

    
      
    

    
    
    <meta property="og:title" content="An easy and secure way to store a password using Data Protection API" />
<meta property="og:description" content="If you&rsquo;re writing a client application that needs to store user credentials, it&rsquo;s usually not a good idea to store the password as plain text, for obvious security reasons. So you need to encrypt it, but as soon as you start to think about encryption, it raises all kinds of issues&hellip; Which algorithm should you use? Which encryption key? Obviously you will need the key to decrypt the password, so it needs to be either in the executable or in the configuration." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog2.thomaslevesque.net/2013/05/21/an-easy-and-secure-way-to-store-a-password-using-data-protection-api/" />
<meta property="article:published_time" content="2013-05-21T00:00:00+00:00" />
<meta property="article:modified_time" content="2013-05-21T00:00:00+00:00" />
<meta itemprop="name" content="An easy and secure way to store a password using Data Protection API">
<meta itemprop="description" content="If you&rsquo;re writing a client application that needs to store user credentials, it&rsquo;s usually not a good idea to store the password as plain text, for obvious security reasons. So you need to encrypt it, but as soon as you start to think about encryption, it raises all kinds of issues&hellip; Which algorithm should you use? Which encryption key? Obviously you will need the key to decrypt the password, so it needs to be either in the executable or in the configuration.">
<meta itemprop="datePublished" content="2013-05-21T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2013-05-21T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="796">



<meta itemprop="keywords" content="cryptography,dpapi,password,protect," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="An easy and secure way to store a password using Data Protection API"/>
<meta name="twitter:description" content="If you&rsquo;re writing a client application that needs to store user credentials, it&rsquo;s usually not a good idea to store the password as plain text, for obvious security reasons. So you need to encrypt it, but as soon as you start to think about encryption, it raises all kinds of issues&hellip; Which algorithm should you use? Which encryption key? Obviously you will need the key to decrypt the password, so it needs to be either in the executable or in the configuration."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://blog2.thomaslevesque.net/" class="f3 fw2 hover-white no-underline white-90 dib">
      Thomas Levesque .NET Blog
    </a>
    <div class="flex-l items-center">
      

      
      














    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://blog2.thomaslevesque.net/2013/05/21/an-easy-and-secure-way-to-store-a-password-using-data-protection-api/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://blog2.thomaslevesque.net/2013/05/21/an-easy-and-secure-way-to-store-a-password-using-data-protection-api/&amp;text=An%20easy%20and%20secure%20way%20to%20store%20a%20password%20using%20Data%20Protection%20API" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog2.thomaslevesque.net/2013/05/21/an-easy-and-secure-way-to-store-a-password-using-data-protection-api/&amp;title=An%20easy%20and%20secure%20way%20to%20store%20a%20password%20using%20Data%20Protection%20API" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>

      <h1 class="f1 athelas mt3 mb1">An easy and secure way to store a password using Data Protection API</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2013-05-21T00:00:00Z">May 21, 2013</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>If you&rsquo;re writing a client application that needs to store user credentials, it&rsquo;s usually not a good idea to store the password as plain text, for obvious security reasons. So you need to encrypt it, but as soon as you start to think about encryption, it raises all kinds of issues&hellip; Which algorithm should you use? Which encryption key? Obviously you will need the key to decrypt the password, so it needs to be either in the executable or in the configuration. But then it will be pretty easy to find&hellip;  Well, the good news is that you don&rsquo;t really need to solve this problem, because Windows already solved it for you! The solution is called <a href="http://msdn.microsoft.com/en-us/library/ms995355.aspx">Data Protection API</a>, and enables you to protect data without having to worry about an encryption key. The documentation is lengthy and boring, but actually it&rsquo;s pretty easy to use from .NET, because the framework provides a <a href="http://msdn.microsoft.com/en-us/library/system.security.cryptography.protecteddata.aspx"><code>ProtectedData</code></a> class that wraps the low-level API calls for you.  This class has two methods, with pretty self-explanatory names: <code>Protect</code> and <code>Unprotect</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span>[] Protect(<span style="color:#66d9ef">byte</span>[] userData, <span style="color:#66d9ef">byte</span>[] optionalEntropy, DataProtectionScope scope);
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span>[] Unprotect(<span style="color:#66d9ef">byte</span>[] encryptedData, <span style="color:#66d9ef">byte</span>[] optionalEntropy, DataProtectionScope scope);
</code></pre></div><p>The <code>userData</code> parameter is the plain, unencrypted binary data. The <code>scope</code> is a value that indicates whether to protect the data for the current user (only that user will be able to decrypt it) or for the local machine (any user on the same machine will be able to decrypt it). What about the <code>optionalEntropy</code> parameter? Well, I&rsquo;m not an expert in cryptography, but as far as I understand, it&rsquo;s a kind of &ldquo;salt&rdquo;: according to the documentation, it is used to &ldquo;increase the complexity of the encryption&rdquo;. Obviously, you&rsquo;ll need to provide the same entropy to decrypt the data later. As the name implies, this parameter is optional, so you can just pass null if you don&rsquo;t want to use it.  So, this API is quite simple, but not directly usable for our goal: the input and output of <code>Protect</code> are byte arrays, but we want to encrypt a password, which is a string; also, it&rsquo;s usually more convenient to store a string than a byte array. To get a byte array from the password string, it&rsquo;s pretty easy: we just need to use a text encoding, like UTF-8. But we can&rsquo;t use the same approach to get a string from the encrypted binary data, because it will probably not contain printable text; instead we can encode the result in Base64, which gives a clean text representation of binary data. So, basically we&rsquo;re going to do this:</p>
<pre><code>                      clear text
(encode to UTF8)   =&gt; clear bytes
(Protect)          =&gt; encrypted bytes
(encode to base64) =&gt; encrypted text
</code></pre><p>And for decryption, we just need to reverse the steps:</p>
<pre><code>                        encrypted text
(decode from base64) =&gt; encrypted bytes
(Unprotect)          =&gt; clear bytes
(decode from UTF8)   =&gt; clear text
</code></pre><p>I omitted the entropy in the description above; in most cases it will probably be more convenient to have it as a string, too, so we can just encode the string to UTF-8 to get the corresponding bytes.  Eventually, we can wrap all this in two simple extension methods:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DataProtectionExtensions</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> Protect(
        <span style="color:#66d9ef">this</span> <span style="color:#66d9ef">string</span> clearText,
        <span style="color:#66d9ef">string</span> optionalEntropy = <span style="color:#66d9ef">null</span>,
        DataProtectionScope scope = DataProtectionScope.CurrentUser)
    {
        <span style="color:#66d9ef">if</span> (clearText == <span style="color:#66d9ef">null</span>)
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(<span style="color:#e6db74">&#34;clearText&#34;</span>);
        <span style="color:#66d9ef">byte</span>[] clearBytes = Encoding.UTF8.GetBytes(clearText);
        <span style="color:#66d9ef">byte</span>[] entropyBytes = <span style="color:#66d9ef">string</span>.IsNullOrEmpty(optionalEntropy)
            ? <span style="color:#66d9ef">null</span>
            : Encoding.UTF8.GetBytes(optionalEntropy);
        <span style="color:#66d9ef">byte</span>[] encryptedBytes = ProtectedData.Protect(clearBytes, entropyBytes, scope);
        <span style="color:#66d9ef">return</span> Convert.ToBase64String(encryptedBytes);
    }
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> Unprotect(
        <span style="color:#66d9ef">this</span> <span style="color:#66d9ef">string</span> encryptedText,
        <span style="color:#66d9ef">string</span> optionalEntropy = <span style="color:#66d9ef">null</span>,
        DataProtectionScope scope = DataProtectionScope.CurrentUser)
    {
        <span style="color:#66d9ef">if</span> (encryptedText == <span style="color:#66d9ef">null</span>)
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(<span style="color:#e6db74">&#34;encryptedText&#34;</span>);
        <span style="color:#66d9ef">byte</span>[] encryptedBytes = Convert.FromBase64String(encryptedText);
        <span style="color:#66d9ef">byte</span>[] entropyBytes = <span style="color:#66d9ef">string</span>.IsNullOrEmpty(optionalEntropy)
            ? <span style="color:#66d9ef">null</span>
            : Encoding.UTF8.GetBytes(optionalEntropy);
        <span style="color:#66d9ef">byte</span>[] clearBytes = ProtectedData.Unprotect(encryptedBytes, entropyBytes, scope);
        <span style="color:#66d9ef">return</span> Encoding.UTF8.GetString(clearBytes);
    }
}
</code></pre></div><p>Encryption example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">string</span> encryptedPassword = password.Protect();
</code></pre></div><p>Decryption example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">try</span>
{
    <span style="color:#66d9ef">string</span> password = encryptedPassword.Unprotect();
}
<span style="color:#66d9ef">catch</span>(CryptographicException)
{
    <span style="color:#75715e">// Possible causes:
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// - the entropy is not the one used for encryption
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// - the data was encrypted by another user (for scope == CurrentUser)
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// - the data was encrypted on another machine (for scope == LocalMachine)
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// In this case, the stored password is not usable; just prompt the user to enter it again.
</span><span style="color:#75715e"></span>}
</code></pre></div><p>What I love with this technique is that it Just Works™: you don&rsquo;t need to worry about how the data is encrypted, where the key is stored, or anything, Windows takes care of everything.  The code above works on the full .NET framework, but the Data Protection API is also available:</p>
<ul>
<li>for Windows Phone: same methods, but without the scope parameter</li>
<li>for Windows Store apps, using the <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.security.cryptography.dataprotection.dataprotectionprovider">DataProtectionProvider</a> class. The API is quite different (async methods, no entropy) and a bit more complex to use, but it achieves the same result. <a href="https://gist.github.com/thomaslevesque/5652991">Here&rsquo;s a WinRT version of the extension methods above</a>.</li>
</ul>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/cryptography" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">cryptography</a>
   </li>
  
   <li class="list">
     <a href="/tags/dpapi" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">dpapi</a>
   </li>
  
   <li class="list">
     <a href="/tags/password" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">password</a>
   </li>
  
   <li class="list">
     <a href="/tags/protect" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">protect</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://blog2.thomaslevesque.net/" >
    &copy;  Thomas Levesque .NET Blog 2020 
  </a>
    <div>













</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
