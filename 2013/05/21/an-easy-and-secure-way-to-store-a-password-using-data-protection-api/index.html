<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>An easy and secure way to store a password using Data Protection API - Thomas Levesque&#39;s .NET Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-31621259-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Thomas Levesque&#39;s .NET Blog" rel="home">
				<div class="logo__title">Thomas Levesque&#39;s .NET Blog</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">An easy and secure way to store a password using Data Protection API</h1>
			
		</header><div class="content post__content clearfix">
			<p>If you&rsquo;re writing a client application that needs to store user credentials, it&rsquo;s usually not a good idea to store the password as plain text, for obvious security reasons. So you need to encrypt it, but as soon as you start to think about encryption, it raises all kinds of issues&hellip; Which algorithm should you use? Which encryption key? Obviously you will need the key to decrypt the password, so it needs to be either in the executable or in the configuration. But then it will be pretty easy to find&hellip;  Well, the good news is that you don&rsquo;t really need to solve this problem, because Windows already solved it for you! The solution is called <a href="http://msdn.microsoft.com/en-us/library/ms995355.aspx">Data Protection API</a>, and enables you to protect data without having to worry about an encryption key. The documentation is lengthy and boring, but actually it&rsquo;s pretty easy to use from .NET, because the framework provides a <a href="http://msdn.microsoft.com/en-us/library/system.security.cryptography.protecteddata.aspx"><code>ProtectedData</code></a> class that wraps the low-level API calls for you.  This class has two methods, with pretty self-explanatory names: <code>Protect</code> and <code>Unprotect</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span>[] Protect(<span style="color:#66d9ef">byte</span>[] userData, <span style="color:#66d9ef">byte</span>[] optionalEntropy, DataProtectionScope scope);
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span>[] Unprotect(<span style="color:#66d9ef">byte</span>[] encryptedData, <span style="color:#66d9ef">byte</span>[] optionalEntropy, DataProtectionScope scope);
</code></pre></div><p>The <code>userData</code> parameter is the plain, unencrypted binary data. The <code>scope</code> is a value that indicates whether to protect the data for the current user (only that user will be able to decrypt it) or for the local machine (any user on the same machine will be able to decrypt it). What about the <code>optionalEntropy</code> parameter? Well, I&rsquo;m not an expert in cryptography, but as far as I understand, it&rsquo;s a kind of &ldquo;salt&rdquo;: according to the documentation, it is used to &ldquo;increase the complexity of the encryption&rdquo;. Obviously, you&rsquo;ll need to provide the same entropy to decrypt the data later. As the name implies, this parameter is optional, so you can just pass null if you don&rsquo;t want to use it.  So, this API is quite simple, but not directly usable for our goal: the input and output of <code>Protect</code> are byte arrays, but we want to encrypt a password, which is a string; also, it&rsquo;s usually more convenient to store a string than a byte array. To get a byte array from the password string, it&rsquo;s pretty easy: we just need to use a text encoding, like UTF-8. But we can&rsquo;t use the same approach to get a string from the encrypted binary data, because it will probably not contain printable text; instead we can encode the result in Base64, which gives a clean text representation of binary data. So, basically we&rsquo;re going to do this:</p>
<pre><code>                      clear text
(encode to UTF8)   =&gt; clear bytes
(Protect)          =&gt; encrypted bytes
(encode to base64) =&gt; encrypted text
</code></pre><p>And for decryption, we just need to reverse the steps:</p>
<pre><code>                        encrypted text
(decode from base64) =&gt; encrypted bytes
(Unprotect)          =&gt; clear bytes
(decode from UTF8)   =&gt; clear text
</code></pre><p>I omitted the entropy in the description above; in most cases it will probably be more convenient to have it as a string, too, so we can just encode the string to UTF-8 to get the corresponding bytes.  Eventually, we can wrap all this in two simple extension methods:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DataProtectionExtensions</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> Protect(
        <span style="color:#66d9ef">this</span> <span style="color:#66d9ef">string</span> clearText,
        <span style="color:#66d9ef">string</span> optionalEntropy = <span style="color:#66d9ef">null</span>,
        DataProtectionScope scope = DataProtectionScope.CurrentUser)
    {
        <span style="color:#66d9ef">if</span> (clearText == <span style="color:#66d9ef">null</span>)
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(<span style="color:#e6db74">&#34;clearText&#34;</span>);
        <span style="color:#66d9ef">byte</span>[] clearBytes = Encoding.UTF8.GetBytes(clearText);
        <span style="color:#66d9ef">byte</span>[] entropyBytes = <span style="color:#66d9ef">string</span>.IsNullOrEmpty(optionalEntropy)
            ? <span style="color:#66d9ef">null</span>
            : Encoding.UTF8.GetBytes(optionalEntropy);
        <span style="color:#66d9ef">byte</span>[] encryptedBytes = ProtectedData.Protect(clearBytes, entropyBytes, scope);
        <span style="color:#66d9ef">return</span> Convert.ToBase64String(encryptedBytes);
    }
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> Unprotect(
        <span style="color:#66d9ef">this</span> <span style="color:#66d9ef">string</span> encryptedText,
        <span style="color:#66d9ef">string</span> optionalEntropy = <span style="color:#66d9ef">null</span>,
        DataProtectionScope scope = DataProtectionScope.CurrentUser)
    {
        <span style="color:#66d9ef">if</span> (encryptedText == <span style="color:#66d9ef">null</span>)
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(<span style="color:#e6db74">&#34;encryptedText&#34;</span>);
        <span style="color:#66d9ef">byte</span>[] encryptedBytes = Convert.FromBase64String(encryptedText);
        <span style="color:#66d9ef">byte</span>[] entropyBytes = <span style="color:#66d9ef">string</span>.IsNullOrEmpty(optionalEntropy)
            ? <span style="color:#66d9ef">null</span>
            : Encoding.UTF8.GetBytes(optionalEntropy);
        <span style="color:#66d9ef">byte</span>[] clearBytes = ProtectedData.Unprotect(encryptedBytes, entropyBytes, scope);
        <span style="color:#66d9ef">return</span> Encoding.UTF8.GetString(clearBytes);
    }
}
</code></pre></div><p>Encryption example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">string</span> encryptedPassword = password.Protect();
</code></pre></div><p>Decryption example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">try</span>
{
    <span style="color:#66d9ef">string</span> password = encryptedPassword.Unprotect();
}
<span style="color:#66d9ef">catch</span>(CryptographicException)
{
    <span style="color:#75715e">// Possible causes:
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// - the entropy is not the one used for encryption
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// - the data was encrypted by another user (for scope == CurrentUser)
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// - the data was encrypted on another machine (for scope == LocalMachine)
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// In this case, the stored password is not usable; just prompt the user to enter it again.
</span><span style="color:#75715e"></span>}
</code></pre></div><p>What I love with this technique is that it Just Works™: you don&rsquo;t need to worry about how the data is encrypted, where the key is stored, or anything, Windows takes care of everything.  The code above works on the full .NET framework, but the Data Protection API is also available:</p>
<ul>
<li>for Windows Phone: same methods, but without the scope parameter</li>
<li>for Windows Store apps, using the <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.security.cryptography.dataprotection.dataprotectionprovider">DataProtectionProvider</a> class. The API is quite different (async methods, no entropy) and a bit more complex to use, but it achieves the same result. <a href="https://gist.github.com/thomaslevesque/5652991">Here&rsquo;s a WinRT version of the extension methods above</a>.</li>
</ul>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/cryptography/" rel="tag">cryptography</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/dpapi/" rel="tag">dpapi</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/password/" rel="tag">password</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/protect/" rel="tag">protect</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>





			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 Thomas Levesque&#39;s .NET Blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>