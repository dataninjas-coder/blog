<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>[WPF] How to bind to data when the DataContext is not inherited - Thomas Levesque&#39;s .NET Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-31621259-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Thomas Levesque&#39;s .NET Blog" rel="home">
				<div class="logo__title">Thomas Levesque&#39;s .NET Blog</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[WPF] How to bind to data when the DataContext is not inherited</h1>
			
		</header><div class="content post__content clearfix">
			<p>The <code>DataContext</code> property in WPF is extremely handy, because it is automatically inherited by all children of the element where you assign it; therefore you don&rsquo;t need to set it again on each element you want to bind. However, in some cases the <code>DataContext</code> is not accessible: it happens for elements that are not part of the visual or logical tree. It can be very difficult then to bind a property on those elements&hellip;  Let&rsquo;s illustrate with a simple example: we want to display a list of products in a <code>DataGrid</code>. In the grid, we want to be able to show or hide the Price column, based on the value of a <code>ShowPrice</code> property exposed by the ViewModel. The obvious approach is to bind the <code>Visibility</code> of the column to the <code>ShowPrice</code> property:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;DataGridTextColumn</span> <span style="color:#a6e22e">Header=</span><span style="color:#e6db74">&#34;Price&#34;</span> <span style="color:#a6e22e">Binding=</span><span style="color:#e6db74">&#34;{Binding Price}&#34;</span> <span style="color:#a6e22e">IsReadOnly=</span><span style="color:#e6db74">&#34;False&#34;</span>
                    <span style="color:#a6e22e">Visibility=</span><span style="color:#e6db74">&#34;{Binding ShowPrice,
</span><span style="color:#e6db74">                        Converter={StaticResource visibilityConverter}}&#34;</span><span style="color:#f92672">/&gt;</span>
</code></pre></div><p>Unfortunately, changing the value of <code>ShowPrice</code> has no effect, and the column is always visible&hellip; why? If we look at the Output window in Visual Studio, we notice the following line:</p>
<blockquote>
<p>System.Windows.Data Error: 2 : Cannot find governing FrameworkElement or FrameworkContentElement for target element. BindingExpression:Path=ShowPrice; DataItem=null; target element is &lsquo;DataGridTextColumn&rsquo; (HashCode=32685253); target property is &lsquo;Visibility&rsquo; (type &lsquo;Visibility&rsquo;)</p>
</blockquote>
<p>The message is rather cryptic, but the meaning is actually quite simple: WPF doesn&rsquo;t know which <code>FrameworkElement</code> to use to get the <code>DataContext</code>, because the column doesn&rsquo;t belong to the visual or logical tree of the <code>DataGrid</code>.  We can try to tweak the binding to get the desired result, for instance by setting the RelativeSource to the <code>DataGrid</code> itself:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;DataGridTextColumn</span> <span style="color:#a6e22e">Header=</span><span style="color:#e6db74">&#34;Price&#34;</span> <span style="color:#a6e22e">Binding=</span><span style="color:#e6db74">&#34;{Binding Price}&#34;</span> <span style="color:#a6e22e">IsReadOnly=</span><span style="color:#e6db74">&#34;False&#34;</span>
                    <span style="color:#a6e22e">Visibility=</span><span style="color:#e6db74">&#34;{Binding DataContext.ShowPrice,
</span><span style="color:#e6db74">                        Converter={StaticResource visibilityConverter},
</span><span style="color:#e6db74">                        RelativeSource={RelativeSource FindAncestor, AncestorType=DataGrid}}&#34;</span><span style="color:#f92672">/&gt;</span>
</code></pre></div><p>Or we can add a <code>CheckBox</code> bound to <code>ShowPrice</code>, and try to bind the column visibility to the <code>IsChecked</code> property by specifying the element name:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;DataGridTextColumn</span> <span style="color:#a6e22e">Header=</span><span style="color:#e6db74">&#34;Price&#34;</span> <span style="color:#a6e22e">Binding=</span><span style="color:#e6db74">&#34;{Binding Price}&#34;</span> <span style="color:#a6e22e">IsReadOnly=</span><span style="color:#e6db74">&#34;False&#34;</span>
                    <span style="color:#a6e22e">Visibility=</span><span style="color:#e6db74">&#34;{Binding IsChecked,
</span><span style="color:#e6db74">                        Converter={StaticResource visibilityConverter},
</span><span style="color:#e6db74">                        ElementName=chkShowPrice}&#34;</span><span style="color:#f92672">/&gt;</span>
</code></pre></div><p>But none of these workarounds seems to work, we always get the same result&hellip;  At this point, it seems that the only viable approach would be to change the column visibility in code-behind, which we usually prefer to avoid when using the MVVM pattern&hellip; But I&rsquo;m not going to give up so soon, at least not while there are other options to consider ;)  The solution to our problem is actually quite simple, and takes advantage of the <a href="http://msdn.microsoft.com/en-us/library/system.windows.freezable.aspx"><code>Freezable</code></a> class. The primary purpose of this class is to define objects that have a modifiable and a read-only state, but the interesting feature in our case is that <code>Freezable</code> objects can inherit the <code>DataContext</code> even when they&rsquo;re not in the visual or logical tree. I don&rsquo;t know the exact mechanism that enables this behavior, but we&rsquo;re going to take advantage of it to make our binding work&hellip;  The idea is to create a class (I called it <code>BindingProxy</code> for reasons that should become obvious very soon) that inherits <code>Freezable</code> and declares a <code>Data</code> dependency property:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BindingProxy</span> : Freezable
    {
        <span style="color:#75715e">#region Overrides of Freezable
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> Freezable CreateInstanceCore()
        {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> BindingProxy();
        }

        <span style="color:#75715e">#endregion
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">object</span> Data
        {
            <span style="color:#66d9ef">get</span> { <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">object</span>)GetValue(DataProperty); }
            <span style="color:#66d9ef">set</span> { SetValue(DataProperty, <span style="color:#66d9ef">value</span>); }
        }

        <span style="color:#75715e">// Using a DependencyProperty as the backing store for Data.  This enables animation, styling, binding, etc...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> DependencyProperty DataProperty =
            DependencyProperty.Register(<span style="color:#e6db74">&#34;Data&#34;</span>, <span style="color:#66d9ef">typeof</span>(<span style="color:#66d9ef">object</span>), <span style="color:#66d9ef">typeof</span>(BindingProxy), <span style="color:#66d9ef">new</span> UIPropertyMetadata(<span style="color:#66d9ef">null</span>));
    }
</code></pre></div><p>We can then declare an instance of this class in the resources of the <code>DataGrid</code>, and bind the <code>Data</code> property to the current <code>DataContext</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;DataGrid.Resources&gt;</span>
    <span style="color:#f92672">&lt;local:BindingProxy</span> <span style="color:#a6e22e">x:Key=</span><span style="color:#e6db74">&#34;proxy&#34;</span> <span style="color:#a6e22e">Data=</span><span style="color:#e6db74">&#34;{Binding}&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/DataGrid.Resources&gt;</span>
</code></pre></div><p>The last step is to specify this <code>BindingProxy</code> object (easily accessible with <code>StaticResource</code>) as the <code>Source</code> for the binding:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;DataGridTextColumn</span> <span style="color:#a6e22e">Header=</span><span style="color:#e6db74">&#34;Price&#34;</span> <span style="color:#a6e22e">Binding=</span><span style="color:#e6db74">&#34;{Binding Price}&#34;</span> <span style="color:#a6e22e">IsReadOnly=</span><span style="color:#e6db74">&#34;False&#34;</span>
                    <span style="color:#a6e22e">Visibility=</span><span style="color:#e6db74">&#34;{Binding Data.ShowPrice,
</span><span style="color:#e6db74">                        Converter={StaticResource visibilityConverter},
</span><span style="color:#e6db74">                        Source={StaticResource proxy}}&#34;</span><span style="color:#f92672">/&gt;</span>
</code></pre></div><p>Note that the binding path has been prefixed with &ldquo;Data&rdquo;, since the path is now relative to the <code>BindingProxy</code> object.  The binding now works correctly, and the column is properly shown or hidden based on the <code>ShowPrice</code> property.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/binding/" rel="tag">binding</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/datacontext/" rel="tag">datacontext</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/freezable/" rel="tag">freezable</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/wpf/" rel="tag">WPF</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>





			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 Thomas Levesque&#39;s .NET Blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>