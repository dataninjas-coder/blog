<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Easy unit testing of null argument validation (C# 8 edition) - Thomas Levesque&#39;s .NET Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-31621259-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Thomas Levesque&#39;s .NET Blog" rel="home">
				<div class="logo__title">Thomas Levesque&#39;s .NET Blog</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Easy unit testing of null argument validation (C# 8 edition)</h1>
			
		</header><div class="content post__content clearfix">
			<p>A few years ago, I blogged about <a href="https://thomaslevesque.com/2014/11/02/easy-unit-testing-of-null-argument-validation/">a way to automate unit testing of null argument validation</a>. Its usage looked like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">[Fact]</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> FullOuterJoin_Throws_If_Argument_Is_Null()
{
    <span style="color:#66d9ef">var</span> left = Enumerable.Empty&lt;<span style="color:#66d9ef">int</span>&gt;();
    <span style="color:#66d9ef">var</span> right = Enumerable.Empty&lt;<span style="color:#66d9ef">int</span>&gt;();
    TestHelper.AssertThrowsWhenArgumentNull(
        () =&gt; left.FullOuterJoin(right, x =&gt; x, y =&gt; y, (k, x, y) =&gt; <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">null</span>),
        <span style="color:#e6db74">&#34;left&#34;</span>, <span style="color:#e6db74">&#34;right&#34;</span>, <span style="color:#e6db74">&#34;leftKeySelector&#34;</span>, <span style="color:#e6db74">&#34;rightKeySelector&#34;</span>, <span style="color:#e6db74">&#34;resultSelector&#34;</span>);
}
</code></pre></div><p>Basically, for each of the specified parameters, the <code>AssertThrowsWhenArgumentNull</code> method rewrites the lambda expression by replacing the corresponding argument with <code>null</code>, compiles and executes it, and checks that it throws an <code>ArgumentNullException</code> with the appropriate parameter name. This method has served me well for many years, as it drastically reduces the amount of code to test argument validation. However, I wasn&rsquo;t completely satisfied with it, because I still had to specify the names of the non-nullable parameters explicitlyâ€¦</p>
<h2 id="c-8-to-the-rescue">C# 8 to the rescue</h2>
<p>Yesterday, I was working on enabling C# 8 non-nullable reference types on an old library, and I realized that I could take advantage of the nullable metadata to automatically detect which parameters are non-nullable.</p>
<p>Basically, when you compile a library with nullable reference types enabled, method parameters can be annotated with a <code>[Nullable(x)]</code> attribute, where <code>x</code> is a byte value that indicates the nullability of the parameter (it&rsquo;s actually slightly more complicated than that, see <a href="https://codeblog.jonskeet.uk/2019/02/10/nullableattribute-and-c-8/">Jon Skeet&rsquo;s article</a> on the subject). Additionally, there can be a <code>[NullableContext(x)]</code>  attribute on the method or type that indicates the default nullability for the method or type; if a parameter doesn&rsquo;t have the <code>[Nullable]</code> attribute, the default nullability applies.</p>
<p>Using these facts, it&rsquo;s possible to update my old <code>AssertThrowsWhenArgumentNull</code> method to make it detect non-nullable parameters automatically. Here&rsquo;s the result:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">using</span> System;
<span style="color:#66d9ef">using</span> System.Collections.ObjectModel;
<span style="color:#66d9ef">using</span> System.Linq;
<span style="color:#66d9ef">using</span> System.Linq.Expressions;
<span style="color:#66d9ef">using</span> System.Reflection;
<span style="color:#66d9ef">using</span> FluentAssertions;

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestHelper</span>
{
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> NullableContextAttributeName = <span style="color:#e6db74">&#34;System.Runtime.CompilerServices.NullableContextAttribute&#34;</span>;
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> NullableAttributeName = <span style="color:#e6db74">&#34;System.Runtime.CompilerServices.NullableAttribute&#34;</span>;

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> AssertThrowsWhenArgumentNull(Expression&lt;Action&gt; expr)
    {
        <span style="color:#66d9ef">var</span> realCall = expr.Body <span style="color:#66d9ef">as</span> MethodCallExpression;
        <span style="color:#66d9ef">if</span> (realCall == <span style="color:#66d9ef">null</span>)
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentException(<span style="color:#e6db74">&#34;Expression body is not a method call&#34;</span>, nameof(expr));
        
        <span style="color:#66d9ef">var</span> method = realCall.Method;
        <span style="color:#66d9ef">var</span> nullableContextAttribute =
            method.CustomAttributes
            .FirstOrDefault(a =&gt; a.AttributeType.FullName == NullableContextAttributeName)
            ??
            method.DeclaringType.GetTypeInfo().CustomAttributes
            .FirstOrDefault(a =&gt; a.AttributeType.FullName == NullableContextAttributeName);

        <span style="color:#66d9ef">if</span> (nullableContextAttribute <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">null</span>)
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InvalidOperationException(<span style="color:#e6db74">$&#34;The method &#39;{method}&#39; is not in a nullable enable context. Can&#39;t determine non-nullable parameters.&#34;</span>);

        <span style="color:#66d9ef">var</span> defaultNullability = (Nullability)(<span style="color:#66d9ef">byte</span>)nullableContextAttribute.ConstructorArguments[<span style="color:#ae81ff">0</span>].Value;

        <span style="color:#66d9ef">var</span> realArgs = realCall.Arguments;
        <span style="color:#66d9ef">var</span> parameters = method.GetParameters();
        <span style="color:#66d9ef">var</span> paramIndexes = parameters
            .Select((p, i) =&gt; <span style="color:#66d9ef">new</span> { p, i })
            .ToDictionary(x =&gt; x.p.Name, x =&gt; x.i);
        <span style="color:#66d9ef">var</span> paramTypes = parameters
            .ToDictionary(p =&gt; p.Name, p =&gt; p.ParameterType);

        <span style="color:#66d9ef">var</span> nonNullableRefParams = parameters
            .Where(p =&gt; !p.ParameterType.GetTypeInfo().IsValueType &amp;&amp; GetNullability(p, defaultNullability) == Nullability.NotNull);

        <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> param <span style="color:#66d9ef">in</span> nonNullableRefParams)
        {
            <span style="color:#66d9ef">var</span> paramName = param.Name;
            <span style="color:#66d9ef">var</span> args = realArgs.ToArray();
            args[paramIndexes[paramName]] = Expression.Constant(<span style="color:#66d9ef">null</span>, paramTypes[paramName]);
            <span style="color:#66d9ef">var</span> call = Expression.Call(realCall.Object, method, args);
            <span style="color:#66d9ef">var</span> lambda = Expression.Lambda&lt;Action&gt;(call);
            <span style="color:#66d9ef">var</span> action = lambda.Compile();
            action.ShouldThrow&lt;ArgumentNullException&gt;(<span style="color:#e6db74">$&#34;because parameter &#39;{paramName}&#39; is not nullable&#34;</span>)
                .And.ParamName.Should().Be(paramName);
        }
    }

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">enum</span> Nullability
    {
        Oblivious = <span style="color:#ae81ff">0</span>,
        NotNull = <span style="color:#ae81ff">1</span>,
        Nullable = <span style="color:#ae81ff">2</span>
    }

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Nullability GetNullability(ParameterInfo parameter, Nullability defaultNullability)
    {
        <span style="color:#66d9ef">if</span> (parameter.ParameterType.GetTypeInfo().IsValueType)
            <span style="color:#66d9ef">return</span> Nullability.NotNull;

        <span style="color:#66d9ef">var</span> nullableAttribute = parameter.CustomAttributes
            .FirstOrDefault(a =&gt; a.AttributeType.FullName == NullableAttributeName);

        <span style="color:#66d9ef">if</span> (nullableAttribute <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">null</span>)
            <span style="color:#66d9ef">return</span> defaultNullability;

        <span style="color:#66d9ef">var</span> firstArgument = nullableAttribute.ConstructorArguments.First();
        <span style="color:#66d9ef">if</span> (firstArgument.ArgumentType == <span style="color:#66d9ef">typeof</span>(<span style="color:#66d9ef">byte</span>))
        {
            <span style="color:#66d9ef">var</span> <span style="color:#66d9ef">value</span> = (<span style="color:#66d9ef">byte</span>)firstArgument.Value;
            <span style="color:#66d9ef">return</span> (Nullability)<span style="color:#66d9ef">value</span>;
        }
        <span style="color:#66d9ef">else</span>
        {
            <span style="color:#66d9ef">var</span> values = (ReadOnlyCollection&lt;CustomAttributeTypedArgument&gt;)firstArgument.Value;

            <span style="color:#75715e">// Probably shouldn&#39;t happen
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (values.Count == <span style="color:#ae81ff">0</span>)
                <span style="color:#66d9ef">return</span> defaultNullability;

            <span style="color:#66d9ef">var</span> <span style="color:#66d9ef">value</span> = (<span style="color:#66d9ef">byte</span>)values[<span style="color:#ae81ff">0</span>].Value;

            <span style="color:#66d9ef">return</span> (Nullability)<span style="color:#66d9ef">value</span>;
        }
    }
}
</code></pre></div><p>The unit test is now even simpler, since there&rsquo;s no need to specify the parameters to validate:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">[Fact]</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> FullOuterJoin_Throws_If_Argument_Is_Null()
{
    <span style="color:#66d9ef">var</span> left = Enumerable.Empty&lt;<span style="color:#66d9ef">int</span>&gt;();
    <span style="color:#66d9ef">var</span> right = Enumerable.Empty&lt;<span style="color:#66d9ef">int</span>&gt;();
    TestHelper.AssertThrowsWhenArgumentNull(
        () =&gt; left.FullOuterJoin(right, x =&gt; x, y =&gt; y, (k, x, y) =&gt; <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">null</span>));
}
</code></pre></div><p>It will automatically check that each non-nullable parameter is properly validated.</p>
<p>Happy coding!</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/argument-validation/" rel="tag">argument validation</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/c/" rel="tag">C#</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/c#-8/" rel="tag">C# 8</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/non-nullable-reference-types/" rel="tag">non-nullable reference types</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/null-check/" rel="tag">null check</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/unit-testing/" rel="tag">unit testing</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>





			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 Thomas Levesque&#39;s .NET Blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>